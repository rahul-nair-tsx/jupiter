name: SBOM Check
on: [push, pull_request]
jobs:
  sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Download CLI
        run: |
          echo "Downloading CLI from: https://github.com/rahul-nair-tsx/sbom-cli-tool/releases/download/1.0.0/nxsbom-cli"
          curl -L -f -o nxsbom-cli "https://github.com/rahul-nair-tsx/sbom-cli-tool/releases/download/1.0.0/nxsbom-cli" || {
            echo "Error: Failed to download CLI"
            exit 1
          }
          # Verify the downloaded file is a binary
          file nxsbom-cli || echo "Warning: file command not available"
          ls -lh nxsbom-cli
          # Check if it's an HTML error page
          if head -n 1 nxsbom-cli | grep -q "<!DOCTYPE|<html"; then
            echo "Error: Downloaded file appears to be HTML, not a binary"
            head -n 5 nxsbom-cli
            exit 1
          fi
          chmod +x nxsbom-cli
          echo "CLI downloaded and made executable"
      
      - name: Create CLI config
        run: |
          cat > cli-config.json << EOF
          {
            "agentId": "936ef038-7bef-4288-886d-eeda3e8bb62f",
            "keyId": "936ef038-7bef-4288-886d-eeda3e8bb62f-k1",
            "orgId": "72OO5R9SCO",
            "encPublicKey": "QDZvgFwdhRDVpzVkqi2GjmyDCKbGK7kJcOvDb9lkBAc=",
            "serverBaseUrl": "https://82d5812fe332.ngrok-free.app/api/"
          }
          EOF
      
      - name: Generate SBOM
        run: |
          # Verify CLI is executable and valid
          if [ ! -f nxsbom-cli ]; then
            echo "Error: nxsbom-cli not found"
            exit 1
          fi
          if [ ! -x nxsbom-cli ]; then
            echo "Error: nxsbom-cli is not executable"
            chmod +x nxsbom-cli
          fi
          # Check if it's a valid binary (not HTML/text)
          if head -n 1 nxsbom-cli | grep -qE "<!DOCTYPE|<html|Not Found|404"; then
            echo "Error: nxsbom-cli appears to be an HTML error page, not a binary"
            head -n 3 nxsbom-cli
            exit 1
          fi
          # Test CLI execution
          if ! ./nxsbom-cli -V 2>&1; then
            echo "Error: nxsbom-cli execution test failed"
            file nxsbom-cli || true
            ls -lh nxsbom-cli || true
            exit 1
          fi
          # Generate SBOM
          APP_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          APP_VERSION="${{ github.sha }}"
          ./nxsbom-cli generate-new --config cli-config.json --source-type dir --source-path . --app-name "${APP_NAME}" --version "${APP_VERSION}" --output sbom.json
      
      - name: Upload and Check
        env:
          ORG_ID: 72OO5R9SCO
          UPLOAD_SERVER: https://82d5812fe332.ngrok-free.app
        run: |
          # Upload SBOM (applicationId is optional - will auto-create if not provided)
          SBOM_ID=$(curl -s -X POST "${UPLOAD_SERVER}/v1/upload/sbom/cicd" \
            -H "x-org-id: ${ORG_ID}" \
            -F "file=@sbom.json" \
            -F "clientId=693bde842d84d0e636c80b89" \
            -F "organizationId=${ORG_ID}" \
            -F "ownerId=693bde842d84d0e636c80b66" \
            -F "branch=${githubRefName}" \
            -F "commit=${githubSha}" \
            | jq -r '.data.sbomId')
          
          # Poll for completion
          while true; do
            STATUS=$(curl -s "${UPLOAD_SERVER}/v1/sbom/${SBOM_ID}/status" \
              -H "x-org-id: ${ORG_ID}" | jq -r '.data.state')
            if [ "$STATUS" = "COMPLETED" ] || [ "$STATUS" = "FAILED" ]; then
              break
            fi
            sleep 10
          done
          
          # Get decision
          DECISION=$(curl -s "${UPLOAD_SERVER}/v1/sbom/${SBOM_ID}/decision" \
            -H "x-org-id: ${ORG_ID}" | jq -r '.data.decision')
          
          if [ "$DECISION" = "FAIL" ]; then
            echo "SBOM policy check FAILED"
            exit 1
          fi
