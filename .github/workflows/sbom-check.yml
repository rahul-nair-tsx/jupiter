name: SBOM Check
on: [push, pull_request]
jobs:
  sbom:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Download CLI
        run: |
          echo "Downloading CLI from: https://github.com/rahul-nair-tsx/sbom-cli-tool/releases/download/1.0.0/nxsbom-cli"
          curl -L -f -o nxsbom-cli "https://github.com/rahul-nair-tsx/sbom-cli-tool/releases/download/1.0.0/nxsbom-cli" || {
            echo "Error: Failed to download CLI"
            exit 1
          }
          # Verify the downloaded file is a binary
          file nxsbom-cli || echo "Warning: file command not available"
          ls -lh nxsbom-cli
          # Check if it's an HTML error page
          if head -n 1 nxsbom-cli | grep -q "<!DOCTYPE|<html"; then
            echo "Error: Downloaded file appears to be HTML, not a binary"
            head -n 5 nxsbom-cli
            exit 1
          fi
          chmod +x nxsbom-cli
          echo "CLI downloaded and made executable"
      
      - name: Create CLI config
        run: |
          cat > cli-config.json << EOF
          {
            "agentId": "936ef038-7bef-4288-886d-eeda3e8bb62f",
            "keyId": "936ef038-7bef-4288-886d-eeda3e8bb62f-k1",
            "orgId": "72OO5R9SCO",
            "encPublicKey": "QDZvgFwdhRDVpzVkqi2GjmyDCKbGK7kJcOvDb9lkBAc=",
            "serverBaseUrl": "https://82d5812fe332.ngrok-free.app/api/"
          }
          EOF
      
      - name: Generate SBOM
        run: |
          # Verify CLI is executable and valid
          if [ ! -f nxsbom-cli ]; then
            echo "Error: nxsbom-cli not found"
            exit 1
          fi
          if [ ! -x nxsbom-cli ]; then
            echo "Error: nxsbom-cli is not executable"
            chmod +x nxsbom-cli
          fi
          # Check if it's a valid binary (not HTML/text)
          if head -n 1 nxsbom-cli | grep -qE "<!DOCTYPE|<html|Not Found|404"; then
            echo "Error: nxsbom-cli appears to be an HTML error page, not a binary"
            head -n 3 nxsbom-cli
            exit 1
          fi
          # Test CLI execution
          if ! ./nxsbom-cli -V 2>&1; then
            echo "Error: nxsbom-cli execution test failed"
            file nxsbom-cli || true
            ls -lh nxsbom-cli || true
            exit 1
          fi
          # Generate SBOM
          APP_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          APP_VERSION="${{ github.sha }}"
          ./nxsbom-cli generate-new --config cli-config.json --source-type dir --source-path . --app-name "${APP_NAME}" --version "${APP_VERSION}" --output sbom.json
      
      - name: Upload and Check
        env:
          ORG_ID: 72OO5R9SCO
          UPLOAD_SERVER: https://82d5812fe332.ngrok-free.app
        run: |
          # Upload SBOM (applicationId is optional - will auto-create if not provided)
          UPLOAD_RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST "${UPLOAD_SERVER}/v1/upload/sbom/cicd" \
            -H "x-org-id: ${ORG_ID}" \
            -F "file=@sbom.json" \
            -F "clientId=693bde842d84d0e636c80b89" \
            -F "organizationId=${ORG_ID}" \
            -F "ownerId=693bde842d84d0e636c80b66" \
            -F "branch=${githubRefName}" \
            -F "commit=${githubSha}")
          
          # Extract HTTP status and response body
          HTTP_STATUS=$(echo "$UPLOAD_RESPONSE" | grep -o "HTTP_STATUS:[0-9]*" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$UPLOAD_RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')
          
          # Check HTTP status
          if [ "$HTTP_STATUS" != "200" ] && [ "$HTTP_STATUS" != "201" ] && [ "$HTTP_STATUS" != "202" ]; then
            echo "Error: Upload failed with HTTP status $HTTP_STATUS"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi
          
          # Extract SBOM ID from response
          SBOM_ID=$(echo "$RESPONSE_BODY" | jq -r '.data.sbomId // .sbomId // empty' 2>/dev/null)
          if [ -z "$SBOM_ID" ] || [ "$SBOM_ID" = "null" ]; then
            echo "Error: Failed to get SBOM ID from response"
            echo "Response: $RESPONSE_BODY"
            exit 1
          fi
          echo "SBOM uploaded successfully. SBOM ID: $SBOM_ID"
          
          # Poll for completion
          echo "Polling for SBOM processing status..."
          MAX_ATTEMPTS=60
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            STATUS_RESPONSE=$(curl -s "${UPLOAD_SERVER}/v1/sbom/${SBOM_ID}/status" \
              -H "x-org-id: ${ORG_ID}")
            STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.data.state // .state // empty' 2>/dev/null)
            
            if [ -z "$STATUS" ]; then
              echo "Warning: Could not parse status from response: $STATUS_RESPONSE"
              STATUS="UNKNOWN"
            fi
            
            echo "Attempt $((ATTEMPT + 1))/$MAX_ATTEMPTS: Status = $STATUS"
            
            if [ "$STATUS" = "COMPLETED" ] || [ "$STATUS" = "FAILED" ]; then
              break
            fi
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done
          
          if [ "$STATUS" != "COMPLETED" ] && [ "$STATUS" != "FAILED" ]; then
            echo "Error: SBOM processing did not complete within timeout"
            exit 1
          fi
          
          # Get decision
          echo "Getting policy decision..."
          DECISION_RESPONSE=$(curl -s "${UPLOAD_SERVER}/v1/sbom/${SBOM_ID}/decision" \
            -H "x-org-id: ${ORG_ID}")
          DECISION=$(echo "$DECISION_RESPONSE" | jq -r '.data.decision // .decision // empty' 2>/dev/null)
          
          if [ -z "$DECISION" ]; then
            echo "Warning: Could not parse decision from response: $DECISION_RESPONSE"
            echo "Assuming PASS (no decision available)"
            DECISION="PASS"
          fi
          
          echo "Policy decision: $DECISION"
          
          if [ "$DECISION" = "FAIL" ]; then
            echo "SBOM policy check FAILED"
            exit 1
          fi
          
          echo "SBOM policy check PASSED"
